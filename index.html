<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D åœ£è¯å¾‹åŠ¨ - å›½å†…åŠ é€Ÿç‰ˆ</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/normalize/5.0.0/normalize.min.css">
    <style>
        :root { --netease-red: #C20C0C; --bg-dark: #161616; --text-gold: #c5a880; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; color: var(--text-gold); font-family: "Microsoft YaHei", -apple-system, sans-serif; }
        
        #overlay { position: absolute; z-index: 10; background: rgba(22, 22, 22, 0.95); padding: 2rem; border-radius: 20px; border: 1px solid rgba(194, 12, 12, 0.4); text-align: center; width: 92%; max-width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .title { color: #fff; font-size: 1.4rem; margin-bottom: 10px; font-weight: bold; }
        .subtitle { font-size: 0.85rem; color: #999; margin-bottom: 20px; line-height: 1.4; }
        
        .btn { background: #222; border: 1px solid #444; color: #ddd; padding: 14px; width: 100%; margin-bottom: 12px; border-radius: 50px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; outline: none; }
        .btn:active { background: #333; transform: scale(0.98); }
        .btn-primary { background: var(--netease-red); border: none; color: white; font-weight: bold; margin-bottom: 20px; }
        
        .separator { margin: 15px 0; font-size: 0.75rem; color: #555; display: flex; align-items: center; }
        .separator::before, .separator::after { content: ""; flex: 1; height: 1px; background: #333; margin: 0 10px; }
        
        label { display: block; background: rgba(197, 168, 128, 0.05); border: 1px dashed var(--text-gold); padding: 15px; border-radius: 12px; cursor: pointer; color: var(--text-gold); font-size: 0.9rem; }
        .text-loading { color: var(--netease-red); font-weight: bold; padding: 20px; }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="menu-content">
            <div class="title">ğŸ„ åœ£è¯å¾‹åŠ¨æ’­æ”¾å™¨</div>
            <div class="subtitle">iPhone ç”¨æˆ·è¯·ç¡®ä¿**å…³é—­é™éŸ³å¼€å…³**<br>å»ºè®®ä¸‹è½½æ­Œæ›²åç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
            
            <button class="btn btn-primary" onclick="window.open('orpheus://')">æ‰“å¼€ç½‘æ˜“äº‘ App é€‰æ­Œ</button>
            
            <div class="separator">æ¼”ç¤ºæ›²ç›® (å›½å†… CDN åŠ é€Ÿ)</div>
            <button class="btn" onclick="handleAudioSelection(0)">ç»å…¸åœ£è¯ - Jingle Bells</button>
            <button class="btn" onclick="handleAudioSelection(1)">å®é™ä¹‹å¤œ - Silent Night</button>
            
            <div class="separator">æœ¬åœ°è§£æ (æ”¯æŒç½‘æ˜“äº‘ä¸‹è½½æ–‡ä»¶)</div>
            <input type="file" id="upload" accept="audio/*" hidden />
            <label for="upload">ğŸ“ ç‚¹å‡»ä¸Šä¼ ä¸‹è½½å¥½çš„ MP3</label>
        </div>
        <div id="loading-status" style="display:none" class="text-loading">æ­£åœ¨ä¸‹è½½äº‘ç«¯èµ„æº...</div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r115/three.min.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/shaders/CopyShader.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://lib.baomitu.com/three.js/r115/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        const { PI, sin, cos } = Math;
        const TAU = 2 * PI;
        let scene, camera, renderer, analyser, composer, audio, listener;
        let step = 0;
        const uniforms = { time: { value: 0.0 }, step: { value: 0.0 } };
        const fftSize = 2048;

        // åˆå§‹åŒ–éŸ³é¢‘ï¼ˆæå‰è§£é” iOSï¼‰
        listener = new THREE.AudioListener();
        audio = new THREE.Audio(listener);

        function handleAudioSelection(index) {
            resumeAudioContext();
            loadAudio(index);
        }

        function resumeAudioContext() {
            if (THREE.AudioContext.getContext().state === 'suspended') {
                THREE.AudioContext.getContext().resume();
            }
        }

        document.getElementById("upload").addEventListener("change", function(e) {
            resumeAudioContext();
            uploadAudio(e);
        }, false);

        function showLoading(msg) {
            document.getElementById("menu-content").style.display = "none";
            document.getElementById("loading-status").style.display = "block";
            document.getElementById("loading-status").innerText = msg;
        }

        function loadAudio(i) {
            showLoading("æ­£åœ¨ä»äº‘ç«¯åŠ è½½éŸ³ä¹...");
            // æ›¿æ¢ä¸ºå›½å†…æ›´ç¨³å®šçš„ HTTPS éŸ³ä¹æ¼”ç¤ºèµ„æº (ä½¿ç”¨å…¬å…±ç‰ˆæƒåº“é“¾æ¥)
            const files = [
                "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"
            ];

            new THREE.AudioLoader().load(files[i], function (buffer) {
                audio.setBuffer(buffer);
                audio.setLoop(true);
                audio.play();
                analyser = new THREE.AudioAnalyser(audio, fftSize);
                initScene();
            }, (xhr) => {
                const p = Math.round(xhr.loaded / xhr.total * 100);
                if(!isNaN(p)) document.getElementById("loading-status").innerText = `éŸ³ä¹ä¸‹è½½è¿›åº¦: ${p}%`;
            });
        }

        function uploadAudio(event) {
            showLoading("æœ¬åœ°æ–‡ä»¶è§£æä¸­...");
            const reader = new FileReader();
            reader.onload = function (e) {
                THREE.AudioContext.getContext().decodeAudioData(e.target.result, function (buffer) {
                    audio.setBuffer(buffer);
                    audio.play();
                    analyser = new THREE.AudioAnalyser(audio, fftSize);
                    initScene();
                });
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        }

        function initScene() {
            document.getElementById("overlay").style.display = "none";
            scene = new THREE.Scene();
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(-0.09, -2.55, 24.42);

            const format = renderer.capabilities.isWebGL2 ? THREE.RedFormat : THREE.LuminanceFormat;
            uniforms.tAudioData = { value: new THREE.DataTexture(analyser.data, fftSize / 2, 1, format) };

            addPlane(scene, uniforms);
            addSnow(scene, uniforms);
            for(let i=0; i<10; i++) {
                addTree(scene, uniforms, 4000, [20, 0, -20 * i]);
                addTree(scene, uniforms, 4000, [-20, 0, -20 * i]);
            }

            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));
            composer.addPass(new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85));

            window.addEventListener("resize", () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        function animate(time) {
            analyser.getFrequencyData();
            uniforms.tAudioData.value.needsUpdate = true;
            step = (step + 1) % 1000;
            uniforms.time = { value: time };
            uniforms.step = { value: step };
            composer.render();
            requestAnimationFrame(animate);
        }

        // 3D æ ¸å¿ƒæ¸²æŸ“å‡½æ•°
        function addTree(scene, uniforms, totalPoints, pos) {
            const geo = new THREE.BufferGeometry();
            const positions = [], colors = [], mIndex = [];
            for (let i = 0; i < totalPoints; i++) {
                const t = Math.random();
                const y = (t * 18) - 8;
                const ang = (t * 6 * TAU) + (TAU / 2 * (i % 2));
                const r = (1 - t) * 5;
                positions.push(r * cos(ang) + (Math.random()-0.5)*0.3, y, r * sin(ang) + (Math.random()-0.5)*0.3);
                const color = new THREE.Color();
                color.setHSL(1 - t, 1.0, 0.5);
                colors.push(color.r, color.g, color.b);
                mIndex.push(1 - t);
            }
            geo.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute("mIndex", new THREE.Float32BufferAttribute(mIndex, 1));
            const mat = new THREE.ShaderMaterial({
                uniforms: { ...uniforms, pointTexture: { value: new THREE.TextureLoader().load("https://cdn.jsdelivr.net/gh/mrdoob/three.js@r115/examples/textures/sprites/spark1.png") } },
                vertexShader: `attribute float mIndex; varying vec3 vColor; varying float vOp; uniform sampler2D tAudioData; void main() { vColor = color; vec4 mvp = modelViewMatrix * vec4(position, 1.0); float amp = texture2D(tAudioData, vec2(mIndex, 0.1)).r; gl_PointSize = (1.0 + amp * 15.0) * (100.0 / -mvp.z); vOp = clamp((mvp.z + 200.0)/200.0, 0.0, 1.0); gl_Position = projectionMatrix * mvp; }`,
                fragmentShader: `varying vec3 vColor; varying float vOp; uniform sampler2D pointTexture; void main() { gl_FragColor = vec4(vColor, vOp) * texture2D(pointTexture, gl_PointCoord); }`,
                blending: THREE.AdditiveBlending, transparent: true, depthTest: false
            });
            const p = new THREE.Points(geo, mat);
            p.position.set(...pos);
            scene.add(p);
        }

        function addSnow(scene, uniforms) {
            const geom = new THREE.BufferGeometry();
            const pos = [], phs = [];
            for (let i = 0; i < 500; i++) {
                pos.push((Math.random()-0.5)*50, 0, -Math.random()*150);
                phs.push(Math.random()*1000);
            }
            geom.setAttribute("position", new THREE.Float32BufferAttribute(pos, 3));
            geom.setAttribute("phase", new THREE.Float32BufferAttribute(phs, 1));
            const mat = new THREE.ShaderMaterial({
                uniforms: { ...uniforms, pointTexture: { value: new THREE.TextureLoader().load("https://cdn.jsdelivr.net/gh/mrdoob/three.js@r115/examples/textures/sprites/snowflake1.png") } },
                vertexShader: `attribute float phase; uniform float step; uniform float time; varying float vOp; void main() { vec3 p = position; p.y = 25.0 - (mod(phase + step, 1000.0) / 1000.0) * 33.0; p.x += sin(time * 0.001 + phase); vec4 mvp = modelViewMatrix * vec4(p, 1.0); vOp = clamp((mvp.z + 150.0)/150.0, 0.0, 1.0); gl_PointSize = 4.0 * (100.0 / -mvp.z); gl_Position = projectionMatrix * mvp; }`,
                fragmentShader: `varying float vOp; uniform sampler2D pointTexture; void main() { gl_FragColor = vec4(1.0, 1.0, 1.0, vOp) * texture2D(pointTexture, gl_PointCoord); }`,
                blending: THREE.AdditiveBlending, transparent: true, depthTest: false
            });
            scene.add(new THREE.Points(geom, mat));
        }

        function addPlane(scene, uniforms) {
            const geo = new THREE.BufferGeometry();
            const pos = [], cols = [];
            for(let i=0; i<2000; i++){
                pos.push((Math.random()-0.5)*50, -8, -Math.random()*150);
                cols.push(0.5, 0.7, 1.0);
            }
            geo.setAttribute("position", new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute("color", new THREE.Float32BufferAttribute(cols, 3));
            const mat = new THREE.ShaderMaterial({
                uniforms: { ...uniforms, pointTexture: { value: new THREE.TextureLoader().load("https://cdn.jsdelivr.net/gh/mrdoob/three.js@r115/examples/textures/sprites/spark1.png") } },
                vertexShader: `varying vec3 vColor; void main() { vColor = color; vec4 mvp = modelViewMatrix * vec4(position, 1.0); gl_PointSize = 2.0 * (300.0 / -mvp.z); gl_Position = projectionMatrix * mvp; }`,
                fragmentShader: `varying vec3 vColor; uniform sampler2D pointTexture; void main() { gl_FragColor = vec4(vColor, 1.0) * texture2D(pointTexture, gl_PointCoord); }`,
                blending: THREE.AdditiveBlending, transparent: true, depthTest: false
            });
            scene.add(new THREE.Points(geo, mat));
        }
    </script>
</body>
</html>